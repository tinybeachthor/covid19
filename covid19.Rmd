---
title: "COVID-19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(zoo)
library(nonlinearTseries)
library(plot3D)
library(gganimate)
```

## COVID-19 chaos model

Chaos model for COVID-19 EU data.

### Get data

Get data from [European Center for Disease Control (ECDC)](https://www.ecdc.europa.eu).

```{r}
data <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", 
                 na.strings = "", fileEncoding = "UTF-8-BOM", stringsAsFactors = F)

# construct "date_reported" <date> column
data$date_reported <- mdy(paste0(data$month,"-",data$day,"-",data$year))
```

Isolate data from Europe,
from countries with population at least a million,
and select relevant columns only.

```{r}
eu <- data[data$continentExp == "Europe" & data$popData2019 > 1000000,] %>%
  select("date_reported", "cases", "deaths", "countriesAndTerritories", "popData2019")

glimpse(eu)
```

### Transform into timeseries

Get cases and deaths logdiffs per country.

```{r warning=FALSE}
isValid <- function(x) {
  !is.nan(x) & is.finite(x) & x != 0
}

euClean <- eu %>% 
  arrange(date_reported) %>%
  group_by(countriesAndTerritories) %>%
  mutate(
    cases_growth = cases / lag(cases),
    deaths_growth = deaths / lag(deaths),
    cases_logdiff = log(cases) - log(lag(cases)),
    deaths_logdiff = log(deaths) - log(lag(deaths))) %>%
  tail(-1) %>% 
  filter(isValid(cases_logdiff), 
         isValid(deaths_logdiff),
         isValid(cases_growth),
         isValid(deaths_growth)) %>%
  group_split()
names(euClean) = unique(eu$countriesAndTerritories)

euWeeklyClean <- eu %>% 
  arrange(date_reported) %>%
  group_by(countriesAndTerritories, week = isoweek(date_reported)) %>%
  summarize(cases = sum(cases), deaths = sum(deaths)) %>%
  mutate(
    cases_growth = cases / lag(cases),
    deaths_growth = deaths / lag(deaths)) %>%
  filter(isValid(cases_growth),
         isValid(deaths_growth)) %>%
  group_split()
names(euWeeklyClean) = unique(eu$countriesAndTerritories)

```

Pick a country for further analysis.

```{r}
country <- euClean$Czechia
countryWeekly <- euWeeklyClean$Czechia

glimpse(country)
```

### Plot

```{r eval=T, echo=F}
par(mfrow = c(2, 1))

ggplot(country %>% 
         select(date_reported, cases, deaths) %>%
         pivot_longer(-date_reported, names_to = "variable", values_to = "value"),
       aes(date_reported, value, colour = variable)) +
  geom_point() +
  ggtitle("raw timeseries")

ggplot(countryWeekly %>%
         select(week, cases, deaths) %>%
         pivot_longer(-week, names_to = "variable", values_to = "value"),
       aes(week, value, colour = variable)) +
  geom_point() +
  ggtitle("raw timeseries - weekly")
```

```{r eval=T, echo=F}
par(mfrow = c(2, 1))

ggplot(country %>% 
         select(date_reported, cases_growth, deaths_growth) %>%
         pivot_longer(-date_reported, names_to = "variable", values_to = "value"),
       aes(date_reported, value, colour = variable)) +
  geom_line() +
  ggtitle("growth factors")

ggplot(countryWeekly %>%
         select(week, cases_growth, deaths_growth) %>%
         pivot_longer(-week, names_to = "variable", values_to = "value"),
       aes(week, value, colour = variable)) +
  geom_line() +
  ggtitle("growth factors - weekly")
```


### Reconstruct phase space

Takenâ€™s embedding theorem.

_Use weekly sums to avoid weekend fluctuations._

```{r}
ts <- as.ts(zoo(countryWeekly$cases_growth, order.by = countryWeekly$week))
ts <- na.contiguous(ts)

dfa.analysis = dfa(time.series = ts, npoints = 30,
                   window.size.range=c(3,20),
                   do.plot=FALSE)
ts.estimation = estimate(dfa.analysis, do.plot = TRUE,
                          fit.col="blue",fit.lwd=2,fit.lty=2,
                          main="Fitting DFA")
```

```{r}
par(mfrow = c(1, 2))
# tau-delay estimation based on the autocorrelation function
tau.acf = timeLag(ts, technique = "acf", lag.max = 15, do.plot = T)
# tau-delay estimation based on the mutual information function
tau.ami = timeLag(ts, technique = "ami", lag.max = 15, do.plot = T)
```

```{r}
emb.dim = estimateEmbeddingDim(ts, time.lag = tau.ami, max.embedding.dim = 15)
```

```{r}
tak = buildTakens(ts, embedding.dim = emb.dim, time.lag = tau.ami)

scatter3D(tak[,1], tak[,2], tak[,3],
          col = "red", type="o",cex = 0.3)
```

```{r animation, eval=FALSE, include=FALSE}
anim <- ggplot(data.frame(tak)) +
  geom_path(aes(x = X1, y = X2, 
                col = "red"), show.legend = FALSE) +
  transition_reveal(1:nrow(tak))

animate(anim, renderer = magick_renderer(), fps = 5)
```
